{"pageProps":{"post":{"slug":"16","content":"## やりたいこと\n\nSlack API 経由で Slack へ絵文字を追加したい\n\n## 調べたこと\n\n### 方針1: Slack API の admin.emoji.add を利用する\n\n公式で用意されている絵文字追加用 API。\n\n> 公式ドキュメント: https://api.slack.com/methods/admin.emoji.add\n\nただし、結局この API は使えなかった。理由はこの API を利用するには Slack App に `admin.teams:write` という権限を付与する必要があったから。\n\n> `admin.teams:write` についての公式ドキュメント: https://api.slack.com/scopes/admin.teams:write\n\nこれには次の問題があったので今回は方針を変更することにした:\n\n- Admin API は個々のワークスペースではなく組織全体に影響を与えることができ、ただ絵文字を追加するだけの用途で付与するには不適当なため\n- そもそも Enterprise 版でないと利用できないため\n\n### 方針2: 一般公開されていない API /api/emoji.add を利用する\n\nどうやら Slack には一般公開されていない API がいくつかあるらしく、その中の一つである `/api/emoji.add` を利用すれば絵文字の追加が可能らしい:\n\n> 参考: https://github.com/slackhq/slack-api-docs/issues/28#issuecomment-424195796\n\nこの API を利用しているプロダクトがいくつかあるようだったので、それらを参考に API を叩いてみた。 API を叩く手順は次の通り。\n\n#### /api/emoji.add API を叩く手順\n\n##### 1. トークンを入手する\n\n1. 絵文字を追加したいワークスペースを開く\n2. 開発者ツールを開き、コンソールタブで次のコマンドを実行する\n\n> ```js\n> JSON.parse(localStorage.localConfig_v2).teams[document.location.pathname.match(/^\\/client\\/(T[A-Z0-9]+)/)[1]].token\n> ```\n> 引用: https://github.com/jackellenberger/emojme/blob/master/README.md#cookie-token-one-liner\n\n`xoxc-xxxxxxxxxx` といった形式のトークンが返ってくるはず。\n\n##### 2. Cookie を入手する\n\n1. `https://<TEAM_ID>.slack.com/customize/emoji` を開く（ワークスペースを開いた状態で「以下をカスタマイズ」をクリックすると飛べる）\n2. 開発者ツールを開き、「ネットワーク」タブを開く\n3. `emoji` というドキュメントを選択する\n4. リクエストヘッダーの `cookie:` の値が入手したい Cookie （この値をコピーするとき、「右クリック > 『値をコピー』」だとコピー後の文字列に日本語が混じって後で困るので、範囲選択でコピーする必要がある）\n\n##### 3. API を叩く\n\nAPI を叩くコード:\n\n```python\nimport requests\n\nTOKEN = \"xoxc-xxxxxxxxxx\"   # トークン\nCOOKIE = \"xxxxxxxxxx\"   # Cookie\n\nteam_name = \"xxxxxxxxxx\"    # ワークスペースのチーム名\nemoji_name = \"emoji\"   # 絵文字の名前\nemoji_img_filepath = \"./emoji.png\"   # 絵文字の画像ファイルへのパス\n\nURL_ADD = \"https://{team_name}.slack.com/api/emoji.add\"\nr = requests.post(\n    URL_ADD.format(team_name=team_name),\n    headers = {'Cookie': COOKIE},\n    data = {\n        'mode': 'data',\n        'name': emoji_name,\n        'token': TOKEN\n    },\n    files={'image': open(emoji_img_filepath, 'rb')}\n)\n```\n\n次のレスポンスが返ってきていれば成功:\n\n```\n{\"ok\":true}\n```\n\n## 残る課題\n\n- トークンと Cookie の入手を自動でできないか？\n\n## 余談\n\n### `/api/emoji.add` の xoxb トークンでの利用について\n\n`/api/emoji.add` を xoxb トークンで利用できるよう求める Issue が2019年1月に建てられているが、2023年5月現在、まだ Open なままである。\n\n> 該当 Issue: https://github.com/slackhq/slack-api-docs/issues/95\n\n### xoxc トークンをスクレイピングで入手する\n\n`https://<TEAM_ID>.slack.com/customize/emoji` ページをスクレイピングすることで xoxc トークンを入手している例を紹介している [記事](https://codenote.net/tool/4487.html) を見つけた。\n\n> 該当コード: https://github.com/smashwilson/slack-emojinator/blob/fbcf759ebbda8bd37b77c91362edde9fd3e0c05a/upload.py#L81-L94\n\nしかし、やってみたがうまくいかなかった（ `api_token:` の値が `\"\"` だった）。やってみた当時はまだトークンや Cookie の入手などが手探りの状態だったので、それが原因でうまくいかなかったのかも…？\n\n## 参考\n- [Slack で絵文字を追加するサービスを作ろうとしたときに調べたこと](https://hirotoohira.link/how-to-add-slack-emoji-on-api/)\n- [Slack Custom Emoji を追加する非公開 API /api/emoji.add | CodeNote](https://codenote.net/tool/4487.html)\n- [smashwilson/slack-emojinator: Bulk upload emoji into Slack](https://github.com/smashwilson/slack-emojinator)\n- [Fauntleroy/neutral-face-emoji-tools: Utilities that make life as a Slack emoji addict a little easier.](https://github.com/Fauntleroy/neutral-face-emoji-tools)\n- [jackellenberger/emojme: very powerful very stupid Slack emoji tools, holy cow!](https://github.com/jackellenberger/emojme/tree/master)\n\n","title":"API経由でSlackへカスタム絵文字を追加できないか調査したときのメモ","posted_at":"2023年05月07日 01時56分","updated_at":"2023年05月07日 17時54分","tags":[],"description":"## やりたいこと  Slack API 経由で Slack へ絵文字を追加したい  ## 調べたこと  ### 方針1: Slack API の admin.emoji.add を利用する  公式で用意されている絵文字追加用 API。  > 公式ドキュメント: https://api.slack.com/methods/admin.emoji.add  ただし、結局この API は使えなかった。..."},"config":{"blog_title":"yamamoto-yuta.github.io","site_introduction":"Yamamoto's personal blog","copylight_name":"YutaYamamoto","copylight_url":"https://github.com/yamamoto-yuta","issues_page_url":"https://github.com/yamamoto-yuta/yamamoto-yuta.github.io/issues","favicon_image_url":"https://user-images.githubusercontent.com/55144709/217254968-e131c8d3-3846-4569-8d05-06ccdba503a5.png","author_name":"Yuta Yamamoto","author_introduction":"It's me.","avatar_image_url":{"url":"https://user-images.githubusercontent.com/55144709/217254968-e131c8d3-3846-4569-8d05-06ccdba503a5.png","path":"/static/images/config/avatar.webp"},"sns":[{"name":"GitHub","url":"https://github.com/yamamoto-yuta"},{"name":"Twitter","url":"https://twitter.com/__Y4M4MOTO__"},{"name":"Facebook","url":"https://www.facebook.com/atuXamamoto/"}]},"postsMap":{"13":{"slug":"13","title":"自己紹介","tags":[{"name":"star","color":"FBCA04","description":""}],"posted_at":"2023年02月07日 19時44分","content":"","updated_at":"","description":""},"15":{"slug":"15","title":"Works","tags":[{"name":"star","color":"FBCA04","description":""}],"posted_at":"2023年02月07日 21時28分","content":"","updated_at":"","description":""},"17":{"slug":"17","title":"いつも使ってるSlack向け絵文字ジェネレーターがどうやって絵文字を生成してるか調べてみたメモ","tags":[],"posted_at":"2023年05月08日 01時08分","content":"","updated_at":"","description":""},"18":{"slug":"18","title":"Plasmo 触ってみたメモ","tags":[],"posted_at":"2023年06月04日 21時54分","content":"","updated_at":"","description":""},"19":{"slug":"19","title":"個人的TIPSメモ","tags":[{"name":"star","color":"FBCA04","description":""}],"posted_at":"2023年07月02日 23時31分","content":"","updated_at":"","description":""}},"metadata":{},"relatedPosts":[{"slug":"18","title":"Plasmo 触ってみたメモ","tags":[],"posted_at":"2023年06月04日 21時54分","content":"","updated_at":"","description":""},{"slug":"17","title":"いつも使ってるSlack向け絵文字ジェネレーターがどうやって絵文字を生成してるか調べてみたメモ","tags":[],"posted_at":"2023年05月08日 01時08分","content":"","updated_at":"","description":""},{"slug":"15","title":"Works","tags":[{"name":"star","color":"FBCA04","description":""}],"posted_at":"2023年02月07日 21時28分","content":"","updated_at":"","description":""},{"slug":"19","title":"個人的TIPSメモ","tags":[{"name":"star","color":"FBCA04","description":""}],"posted_at":"2023年07月02日 23時31分","content":"","updated_at":"","description":""},{"slug":"13","title":"自己紹介","tags":[{"name":"star","color":"FBCA04","description":""}],"posted_at":"2023年02月07日 19時44分","content":"","updated_at":"","description":""}]},"__N_SSG":true}