<!doctype html><html lang=ja dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content=" ✏️ 編集\n公式ドキュメント:\nThe Trello REST API API Introduction 参考記事:\nTrelloAPI+GAS で Trello のカード移動を Slack に通知する仕組みを作った話 - トレタ開発者ブログ 【Trello】Rest API の備忘録 Discord の Webhook URL を取得 普通に用意\n"><title>Trello + Discord 連携メモ</title>
<link rel=canonical href=https://yamamoto-yuta.github.io/p/trello-discord-integration-notes/><link rel=stylesheet href=/scss/style.min.0304c6baf04e01a8fe70693791cb744d56a3578a3120a8796cefc66825aa39c7.css><meta property='og:title' content="Trello + Discord 連携メモ"><meta property='og:description' content=" ✏️ 編集\n公式ドキュメント:\nThe Trello REST API API Introduction 参考記事:\nTrelloAPI+GAS で Trello のカード移動を Slack に通知する仕組みを作った話 - トレタ開発者ブログ 【Trello】Rest API の備忘録 Discord の Webhook URL を取得 普通に用意\n"><meta property='og:url' content='https://yamamoto-yuta.github.io/p/trello-discord-integration-notes/'><meta property='og:site_name' content='YAMAMOTO Yuta'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2022-10-30T15:00:00+00:00'><meta property='article:modified_time' content='2022-10-30T15:00:00+00:00'><meta name=twitter:title content="Trello + Discord 連携メモ"><meta name=twitter:description content=" ✏️ 編集\n公式ドキュメント:\nThe Trello REST API API Introduction 参考記事:\nTrelloAPI+GAS で Trello のカード移動を Slack に通知する仕組みを作った話 - トレタ開発者ブログ 【Trello】Rest API の備忘録 Discord の Webhook URL を取得 普通に用意\n"><link rel="shortcut icon" href=/images/favicon.ico><style>:root{--ja-font-family:"游ゴシック体", "Yu Gothic", YuGothic, "ヒラギノ角ゴ Pro", "Hiragino Kaku Gothic Pro", "メイリオ", "Meiryo";--base-font-family:"Lato", var(--sys-font-family), var(--ja-font-family), sans-serif}</style><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=メニューを開く・閉じる>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/images/avatar.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>YAMAMOTO Yuta</a></h1><h2 class=site-description>Data Engineer</h2></div></header><ol class=menu-social><li><a href=https://github.com/yamamoto-yuta target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/__Y4M4MOTO__ target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li><li><a href=https://www.facebook.com/atuXamamoto/ target=_blank title=Facebook rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-facebook"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 10v4h3v7h4v-7h3l1-4h-4V8a1 1 0 011-1h3V3h-3a5 5 0 00-5 5v2H7"/></svg></a></li><li><a href=https://qiita.com/yamamoto-yuta target=_blank title=Qiita rel=me><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg></a></li><li><a href=https://zenn.dev/mtb00k target=_blank title=Zenn rel=me><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg></a></li><li><a href=https://speakerdeck.com/yamamotoyuta target=_blank title=SpeakerDeck rel=me><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/output/><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-article"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 4m0 2a2 2 0 012-2h14a2 2 0 012 2v12a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><path d="M7 8h10"/><path d="M7 12h10"/><path d="M7 16h10"/></svg>
<span>Output</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>ダークモード</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目次</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#discord-の-webhook-url-を取得>Discord の Webhook URL を取得</a></li><li><a href=#trello-の-api-キートークンを取得>Trello の API キー、トークンを取得</a></li><li><a href=#gas-と連携>GAS と連携</a></li><li><a href=#trello-に-webhook-を登録する>Trello に Webhook を登録する</a></li><li><a href=#gas-変更の反映方法>GAS 変更の反映方法</a></li><li><a href=#doposte-で受け取る情報><code>doPost(e)</code> で受け取る情報</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/p/trello-discord-integration-notes/>Trello + Discord 連携メモ</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2022-10-30</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>読了時間: 5分</time></div></footer></div></header><section class=article-content><font size=1 align=right><p><a class=link href=https://github.com/yamamoto-yuta/yamamoto-yuta.github.io/blob/main/content/post/trello-discord-integration-notes/index.md target=_blank rel=noopener>✏️ 編集</a></p></font><p>公式ドキュメント:</p><ul><li><a class=link href=https://developer.atlassian.com/cloud/trello/rest/api-group-actions/ target=_blank rel=noopener>The Trello REST API</a></li><li><a class=link href=https://developer.atlassian.com/cloud/trello/guides/rest-api/api-introduction/#api-introduction target=_blank rel=noopener>API Introduction</a></li></ul><p>参考記事:</p><ul><li><a class=link href=https://tech.toreta.in/entry/2019/12/09/210337 target=_blank rel=noopener>TrelloAPI+GAS で Trello のカード移動を Slack に通知する仕組みを作った話 - トレタ開発者ブログ</a></li><li><a class=link href=https://zenn.dev/miyabisun/articles/bb879493e2648b target=_blank rel=noopener>【Trello】Rest API の備忘録</a></li></ul><h2 id=discord-の-webhook-url-を取得>Discord の Webhook URL を取得</h2><p>普通に用意</p><img width=509.25 alt="image.png (29.3 kB)" src=https://img.esa.io/uploads/production/attachments/14751/2022/10/31/74743/a2d36db2-085b-4b27-959f-f5d1c94c1f50.png><h2 id=trello-の-api-キートークンを取得>Trello の API キー、トークンを取得</h2><ol><li>Trello にログインしている状態で次のページにアクセス</li></ol><blockquote><p><a class=link href=https://trello.com/app-key target=_blank rel=noopener>開発者向け API キー</a></p></blockquote><ol start=2><li>API キー、トークンを取得する</li></ol><ul><li>API キー:<ul><li><code>パーソナルキー</code> の欄にある英数字の羅列</li></ul></li><li>トークン:<ul><li><ol><li><a class=link href="https://trello.com/1/authorize?expiration=never&amp;scope=read,write,account&amp;response_type=token&amp;name=Server%20Token&amp;key=5a88c2e2811a40ec930772e37a3a8c53" target=_blank rel=noopener>トークン</a> へアクセス</li></ol></li><li><ol start=2><li>アプリケーションにアカウントへのアクセスを許可</li></ol></li><li><ol start=3><li>発行されたトークンをメモ</li></ol></li></ul></li></ul><ol start=3><li>下記コマンドを実行してレスポンスが返ってきていれば OK</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>curl --request GET \
</span></span><span class=line><span class=cl>  --url &#39;https://api.trello.com/1/members/me/boards?key={APIKey}&amp;token={APIToken}&#39;
</span></span></code></pre></td></tr></table></div></div><h2 id=gas-と連携>GAS と連携</h2><ol><li>通知用チャンネルを作成（権限に <code>Bot</code> を追加しておかないと、Bot から通知できないので注意）</li></ol><img width=505.5 alt="image.png (31.8 kB)" src=https://img.esa.io/uploads/production/attachments/14751/2022/10/31/74743/4545c8a2-8284-4ccc-8329-e67b889259af.png><ol start=2><li>GAS プロジェクトを作成</li></ol><blockquote><p>GAS プロジェクト: <a class=link href="https://script.google.com/d/1l7gtAPJODCdEaUaX7934hNibD5Pn_J0x71Mlgb_G8Nz1YduRz2yd0CAw/edit?usp=sharing" target=_blank rel=noopener>trello_notifier_bot</a></p></blockquote><ol start=3><li>GAS から Discord へ通知を送れるかテスト</li></ol><p>Discord の Webhook URL は環境変数的なものなので、プロジェクト設定からスクリプトプロパティへ追加</p><img width=563.25 alt="image.png (18.7 kB)" src=https://img.esa.io/uploads/production/attachments/14751/2022/10/31/74743/178c189b-5e96-4831-82d8-c91c8b4b2f1f.png><p>サンプルコード:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>function</span> <span class=nx>myFunction</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>scriptProps</span> <span class=o>=</span> <span class=nx>PropertiesService</span><span class=p>.</span><span class=nx>getScriptProperties</span><span class=p>().</span><span class=nx>getProperties</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>payload</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>content</span><span class=o>:</span> <span class=s2>&#34;content&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>embeds</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>title</span><span class=o>:</span> <span class=s2>&#34;title&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>description</span><span class=o>:</span> <span class=s2>&#34;description&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>payloads</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=nx>scriptProps</span><span class=p>.</span><span class=nx>DISCORD_WEBHOOK_URL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>contentType</span><span class=o>:</span> <span class=s2>&#34;application/json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>payload</span><span class=o>:</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>payload</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>UrlFetchApp</span><span class=p>.</span><span class=nx>fetchAll</span><span class=p>(</span><span class=nx>payloads</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>動作結果:
<img width=225 alt="image.png (9.1 kB)" src=https://img.esa.io/uploads/production/attachments/14751/2022/10/31/74743/a092254e-afb0-49d0-9724-1cc349a95fdf.png></p><h2 id=trello-に-webhook-を登録する>Trello に Webhook を登録する</h2><p>下記 POST を送信する。 <code>callbackURL</code> には GAS プロジェクトをデプロイしたときに発行される URL を入れる。 <code>idModel</code> は変更を検知したいボードの ID を入れる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>curl -X POST -H &#34;Content-Type: application/json&#34; \
</span></span><span class=line><span class=cl>https://api.trello.com/1/tokens/{APIToken}/webhooks/ \
</span></span><span class=line><span class=cl>-d &#39;{
</span></span><span class=line><span class=cl>  &#34;key&#34;: &#34;{APIKey}&#34;,
</span></span><span class=line><span class=cl>  &#34;callbackURL&#34;: &#34;http://www.mywebsite.com/trelloCallback&#34;,
</span></span><span class=line><span class=cl>  &#34;idModel&#34;:&#34;4d5ea62fd76aa1136000000c&#34;,
</span></span><span class=line><span class=cl>  &#34;description&#34;: &#34;My first webhook&#34;
</span></span><span class=line><span class=cl>}&#39;
</span></span></code></pre></td></tr></table></div></div><blockquote><p>引用: <a class=link href=https://developer.atlassian.com/cloud/trello/guides/rest-api/webhooks/#creating-a-webhook target=_blank rel=noopener>https://developer.atlassian.com/cloud/trello/guides/rest-api/webhooks/#creating-a-webhook</a></p></blockquote><p>うまくいくと、下記コードの場合、登録したボードに変更を加えると <code>doPost</code> という文字列が Discord へ送信される。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>function</span> <span class=nx>doPost</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>postToDiscord</span><span class=p>(</span><span class=s2>&#34;doPost&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>postToDiscord</span><span class=p>(</span><span class=nx>content</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>payload</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>content</span><span class=o>:</span> <span class=nx>content</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>payloads</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=nx>scriptProps</span><span class=p>.</span><span class=nx>DISCORD_WEBHOOK_URL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>contentType</span><span class=o>:</span> <span class=s2>&#34;application/json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>payload</span><span class=o>:</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>payload</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>UrlFetchApp</span><span class=p>.</span><span class=nx>fetchAll</span><span class=p>(</span><span class=nx>payloads</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>callbackURL</code> の <code>URL</code> は全て大文字なので注意（間違えると、 <code>Value isn't a string.</code> というメッセージが返ってくる）</p><blockquote><p><a class=link href=https://community.developer.atlassian.com/t/when-creating-a-webhook-the-error-value-isnt-a-string/50388 target=_blank rel=noopener>When creating a webhook, the error &ldquo;Value isn&rsquo;t a string.&rdquo; - Trello - The Atlassian Developer Community</a></p></blockquote><p>次の手順で Webhook の登録を行えるようにした:</p><ol><li><code>新しいデプロイ</code> > <code>アクセスできるユーザ: 自分のみ</code> にしてデプロイ</li><li><code>createWebhook()</code> を実行</li><li><code>デプロイを管理</code> > <code>アクセスできるユーザ: 全員</code> に変更</li><li>Trello のボードに変更を加えた時、Discord へ通知が来れば OK</li></ol><p>手順 1 で <code>アクセスできるユーザ: 自分のみ</code> する理由は、全体公開にすると 403 エラーが返ってくるかららしい。</p><blockquote><p>参考: <a class=link href=https://qiita.com/meowmeowcats/items/634c6e084d863f303e72 target=_blank rel=noopener>GAS を使って trello webhook を受ける時のハマりどころ - Qiita</a></p></blockquote><p>1 回作成された Webhook を再度作ろうとするとエラーになる。
<code>新しいデプロイ</code> を実施することで暫定的に回避できる。</p><h2 id=gas-変更の反映方法>GAS 変更の反映方法</h2><p>GAS のコードを変更したら <code>新しいデプロイ</code> を行わないと反映されない。ただし、 <code>新しいデプロイ</code> をすると Callback URL が変わってしまう。</p><p>その場合、 <code>デプロイを管理</code> から新バージョンとしてデプロイすることで、URL を変更せずに反映できる。</p><img width=599.25 alt="image.png (27.4 kB)" src=https://img.esa.io/uploads/production/attachments/14751/2022/11/14/74743/1d44a778-5239-45dd-b06c-6c056c8dd1d5.png><blockquote><p>参考:</p><ul><li><a class=link href=https://wakky.tech/gas-html-doget-error/ target=_blank rel=noopener>【Web】GAS の HTML ファイルが「スクリプト関数が見つかりません：doGet」と出て表示されないときに確認すること【Google Apps Script】 - 映画と旅行とエンジニア</a></li><li><a class=link href=https://ryjkmr.com/gas-web-app-deploy-new-same-url/ target=_blank rel=noopener>GAS の Web アプリで URL を変えずに新バージョンを公開する（新エディタ） - make it easy</a></li></ul></blockquote><h2 id=doposte-で受け取る情報><code>doPost(e)</code> で受け取る情報</h2><ul><li><a class=link href=https://developer.atlassian.com/cloud/trello/guides/rest-api/action-types/ target=_blank rel=noopener>Action Types</a></li><li><a class=link href=https://developer.atlassian.com/cloud/trello/guides/rest-api/object-definitions/ target=_blank rel=noopener>Object Definitions</a></li></ul><p>受け取った情報に Action ID があるので、それを使ってアクション詳細を取得するのが良さそう</p><blockquote><p><a class=link href=https://developer.atlassian.com/cloud/trello/rest/api-group-actions/ target=_blank rel=noopener>The Trello REST API</a></p></blockquote><p>例１）カードのリストを移動した場合:</p><details><pre>
<code>
{
    "id": "63712c0f23c9cc02ffa935ef",
    "idMemberCreator": "5da3f38080e88b1af8e8ff86",
    "data": {
        "card": {
            "idList": "5dd692ca0897377466449231",
            "id": "627bc1e708099f5b7124c099",
            "name": "1曲目の前に名乗り, 挨拶と常套句（余裕があったら）",
            "idShort": 26,
            "shortLink": "cs179j1u"
        },
        "old": {
            "idList": "627bc1c16397f33d596253c0"
        },
        "board": {
            "id": "5dd692c956a9247b4140e18b",
            "name": "2022秋ライブ",
            "shortLink": "szHdDf00"
        },
        "listBefore": {
            "id": "627bc1c16397f33d596253c0",
            "name": "やりたいこと"
        },
        "listAfter": {
            "id": "5dd692ca0897377466449231",
            "name": "やること"
        }
    },
    "appCreator": null,
    "type": "updateCard",
    "date": "2022-11-13T17:40:31.715Z",
    "limits": null,
    "display": {
        "translationKey": "action_move_card_from_list_to_list",
        "entities": {
            "card": {
                "type": "card",
                "idList": "5dd692ca0897377466449231",
                "id": "627bc1e708099f5b7124c099",
                "shortLink": "cs179j1u",
                "text": "1曲目の前に名乗り, 挨拶と常套句（余裕があったら）"
            },
            "listBefore": {
                "type": "list",
                "id": "627bc1c16397f33d596253c0",
                "text": "やりたいこと"
            },
            "listAfter": {
                "type": "list",
                "id": "5dd692ca0897377466449231",
                "text": "やること"
            },
            "memberCreator": {
                "type": "member",
                "id": "5da3f38080e88b1af8e8ff86",
                "username": "user36408094",
                "text": "山本雄太"
            }
        }
    },
    "memberCreator": {
        "id": "5da3f38080e88b1af8e8ff86",
        "activityBlocked": false,
        "avatarHash": "bd843173354efbec0932501d2c787a46",
        "avatarUrl": "https://trello-members.s3.amazonaws.com/5da3f38080e88b1af8e8ff86/bd843173354efbec0932501d2c787a46",
        "fullName": "山本雄太",
        "idMemberReferrer": null,
        "initials": "山本太",
        "nonPublic": {},
        "nonPublicAvailable": true,
        "username": "user36408094"
    }
}
</code>
</pre></details><p>例２）同一リスト内でカードを入れ替えた場合:</p><details><pre>
<code>
{
    "id": "63712d7e1d8da00421bd3234",
    "idMemberCreator": "5da3f38080e88b1af8e8ff86",
    "data": {
        "card": {
            "pos": 229375,
            "id": "627bc2098e68668fe44d5219",
            "name": "背景と照明であわせる",
            "idShort": 28,
            "shortLink": "htmAcLHf"
        },
        "old": {
            "pos": 131071
        },
        "board": {
            "id": "5dd692c956a9247b4140e18b",
            "name": "2022秋ライブ",
            "shortLink": "szHdDf00"
        },
        "list": {
            "id": "627bc1c16397f33d596253c0",
            "name": "やりたいこと"
        }
    },
    "appCreator": null,
    "type": "updateCard",
    "date": "2022-11-13T17:46:38.819Z",
    "limits": null,
    "display": {
        "translationKey": "action_moved_card_higher",
        "entities": {
            "card": {
                "type": "card",
                "pos": 229375,
                "id": "627bc2098e68668fe44d5219",
                "shortLink": "htmAcLHf",
                "text": "背景と照明であわせる"
            },
            "memberCreator": {
                "type": "member",
                "id": "5da3f38080e88b1af8e8ff86",
                "username": "user36408094",
                "text": "山本雄太"
            }
        }
    },
    "memberCreator": {
        "id": "5da3f38080e88b1af8e8ff86",
        "activityBlocked": false,
        "avatarHash": "bd843173354efbec0932501d2c787a46",
        "avatarUrl": "https://trello-members.s3.amazonaws.com/5da3f38080e88b1af8e8ff86/bd843173354efbec0932501d2c787a46",
        "fullName": "山本雄太",
        "idMemberReferrer": null,
        "initials": "山本太",
        "nonPublic": {},
        "nonPublicAvailable": true,
        "username": "user36408094"
    }
}
</code>
</pre></details><p>例３）カードにコメントを追加した場合:</p><details><pre>
<code>
{
    "id": "63712df1630c6c05daf96fd0",
    "idMemberCreator": "5da3f38080e88b1af8e8ff86",
    "data": {
        "text": "aaaaa",
        "textData": {
            "emoji": {}
        },
        "card": {
            "id": "627bc1e708099f5b7124c099",
            "name": "1曲目の前に名乗り, 挨拶と常套句（余裕があったら）",
            "idShort": 26,
            "shortLink": "cs179j1u"
        },
        "board": {
            "id": "5dd692c956a9247b4140e18b",
            "name": "2022秋ライブ",
            "shortLink": "szHdDf00"
        },
        "list": {
            "id": "5dd692ca0897377466449231",
            "name": "やること"
        }
    },
    "appCreator": null,
    "type": "commentCard",
    "date": "2022-11-13T17:48:33.824Z",
    "limits": {
        "reactions": {
            "perAction": {
                "status": "ok",
                "disableAt": 900,
                "warnAt": 720
            },
            "uniquePerAction": {
                "status": "ok",
                "disableAt": 17,
                "warnAt": 14
            }
        }
    },
    "display": {
        "translationKey": "action_comment_on_card",
        "entities": {
            "contextOn": {
                "type": "translatable",
                "translationKey": "action_on",
                "hideIfContext": true,
                "idContext": "627bc1e708099f5b7124c099"
            },
            "card": {
                "type": "card",
                "hideIfContext": true,
                "id": "627bc1e708099f5b7124c099",
                "shortLink": "cs179j1u",
                "text": "1曲目の前に名乗り, 挨拶と常套句（余裕があったら）"
            },
            "comment": {
                "type": "comment",
                "text": "aaaaa"
            },
            "memberCreator": {
                "type": "member",
                "id": "5da3f38080e88b1af8e8ff86",
                "username": "user36408094",
                "text": "山本雄太"
            }
        }
    },
    "memberCreator": {
        "id": "5da3f38080e88b1af8e8ff86",
        "activityBlocked": false,
        "avatarHash": "bd843173354efbec0932501d2c787a46",
        "avatarUrl": "https://trello-members.s3.amazonaws.com/5da3f38080e88b1af8e8ff86/bd843173354efbec0932501d2c787a46",
        "fullName": "山本雄太",
        "idMemberReferrer": null,
        "initials": "山本太",
        "nonPublic": {},
        "nonPublicAvailable": true,
        "username": "user36408094"
    }
}
</code>
</pre></details><p>例４）さらにコメントを追加した場合:</p><details><pre>
<code>
{
    "id": "63712e485c9137001535ed3f",
    "idMemberCreator": "5da3f38080e88b1af8e8ff86",
    "data": {
        "text": "bbbbb",
        "textData": {
            "emoji": {}
        },
        "card": {
            "id": "627bc1e708099f5b7124c099",
            "name": "1曲目の前に名乗り, 挨拶と常套句（余裕があったら）",
            "idShort": 26,
            "shortLink": "cs179j1u"
        },
        "board": {
            "id": "5dd692c956a9247b4140e18b",
            "name": "2022秋ライブ",
            "shortLink": "szHdDf00"
        },
        "list": {
            "id": "5dd692ca0897377466449231",
            "name": "やること"
        }
    },
    "appCreator": null,
    "type": "commentCard",
    "date": "2022-11-13T17:50:00.381Z",
    "limits": {
        "reactions": {
            "perAction": {
                "status": "ok",
                "disableAt": 900,
                "warnAt": 720
            },
            "uniquePerAction": {
                "status": "ok",
                "disableAt": 17,
                "warnAt": 14
            }
        }
    },
    "display": {
        "translationKey": "action_comment_on_card",
        "entities": {
            "contextOn": {
                "type": "translatable",
                "translationKey": "action_on",
                "hideIfContext": true,
                "idContext": "627bc1e708099f5b7124c099"
            },
            "card": {
                "type": "card",
                "hideIfContext": true,
                "id": "627bc1e708099f5b7124c099",
                "shortLink": "cs179j1u",
                "text": "1曲目の前に名乗り, 挨拶と常套句（余裕があったら）"
            },
            "comment": {
                "type": "comment",
                "text": "bbbbb"
            },
            "memberCreator": {
                "type": "member",
                "id": "5da3f38080e88b1af8e8ff86",
                "username": "user36408094",
                "text": "山本雄太"
            }
        }
    },
    "memberCreator": {
        "id": "5da3f38080e88b1af8e8ff86",
        "activityBlocked": false,
        "avatarHash": "bd843173354efbec0932501d2c787a46",
        "avatarUrl": "https://trello-members.s3.amazonaws.com/5da3f38080e88b1af8e8ff86/bd843173354efbec0932501d2c787a46",
        "fullName": "山本雄太",
        "idMemberReferrer": null,
        "initials": "山本太",
        "nonPublic": {},
        "nonPublicAvailable": true,
        "username": "user36408094"
    }
}
</code>
</pre></details></section><footer class=article-footer></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><footer class=site-footer><section class=copyright>&copy;
2020 -
2024 YAMAMOTO Yuta</section><section class=powerby><a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> で構築されています。<br>テーマ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.26.0>Stack</a></b> は <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> によって設計されています。</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>